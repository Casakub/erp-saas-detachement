# 2.12.a â€” RBAC & PERMISSIONS (MATRIX) â€” V1.2 (PATCH)

- Statut: DRAFT
- Type: DERIVED / DRAFT â€” does not override LOCKED V1
- Portee: formaliser la matrice RBAC pour les surfaces OpenAPI V1.2.1 (sans logique metier).

## Sources de reference (lecture seule)

- RBAC LOCKED V1: `ERP DÃ©tachement europe/SOCLE TECHNIQUE GELÃ‰ â€” V1 (LOCKED)/2.12.a â€” RBAC & PERMISSIONS (MATRIX) â€” V1 30a688d6a596805ea41ae2abb55cbb97.md`
- OpenAPI V1.2 patch DRAFT: `ERP DÃ©tachement europe/SOCLE TECHNIQUE GELÃ‰ â€” V1.2 (DRAFT)/2.11.a â€” OPENAPI V1.2 (PATCH) â€” SURFACES MANQUANTES 30d688d6a59680e2b6a9d15b762899c1.md`

## Decisions OWNER appliquees (V1.2.1)

1. Auth est geree par Supabase Auth; aucune route auth custom dans cette matrice.
2. Surface fichiers standardisee: `/v1/files` + `/v1/file-links`.
3. Check-in/out standardise via endpoint unique: `POST /v1/check-events`.

## Principes RBAC du patch

- Tous les droits sont tenant-scoped.
- Aucune action cross-tenant n'est autorisee.
- Les restrictions d'ownership (mes propres fichiers, mes propres missions) sont notees comme contraintes contractuelles.
- Ce patch reste DRAFT tant que non valide par owner.

## Endpoint -> Allowed roles (V1.2.1)

| Endpoint | tenant_admin | agency_user | consultant | client_user | worker | system | Forbidden / Notes |
| --- | --- | --- | --- | --- | --- | --- | --- |
| GET /v1/me | âœ… | âœ… | âœ… | âœ… | âœ… | âŒ | Profil courant uniquement. |
| GET /v1/users | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ | Liste users reservee admin tenant. |
| POST /v1/users | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ | Creation user reservee admin tenant. |
| PATCH /v1/users/{user_id} | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ | Edition user reservee admin tenant. |
| POST /v1/users/{user_id}:deactivate | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ | Action administrative sensible. |
| POST /v1/users/{user_id}:reactivate | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ | Action administrative sensible. |
| GET /v1/tenant-settings | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ | Lecture settings: admin + operationnel agence. |
| PATCH /v1/tenant-settings | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ | Ecriture settings reservee admin tenant. |
| POST /v1/files | âœ… | âœ… | âœ… | âŒ | âœ… | âŒ | Upload tenant-scoped; consultant/worker limites au perimetre autorise. |
| GET /v1/files/{file_id} | âœ… | âœ… | âœ… | âœ… | âœ… | âŒ | Acces conditionne au lien valide (`file_links`) et au scope. |
| POST /v1/files/{file_id}:soft-delete | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ | Soft delete reserve admin + operationnel agence. |
| POST /v1/file-links | âœ… | âœ… | âœ… | âŒ | âœ… | âŒ | OWNER ARBITRATION REQUIRED: borne fine worker/consultant (ownership strict). |
| DELETE /v1/file-links/{file_link_id} | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ | Suppression lien reservee admin + operationnel agence. |
| POST /v1/check-events | âœ… | âœ… | âŒ | âŒ | âœ… | âŒ | Worker autorise sur ses missions uniquement; no cross-tenant. |

## Forbidden actions (explicites)

- `client_user`: aucun upload, aucun linking, aucun check-event.
- `worker`: aucune administration users/settings; aucun delete de file-link.
- `consultant`: aucune administration users/settings; aucun check-event.
- `agency_user`: aucune administration users (create/update/deactivate/reactivate).
- `system`: non scope dans ce patch (aucune route ci-dessus).

## Notes de coherence

- Les chemins RBAC correspondent exactement au patch OpenAPI V1.2.1.
- Les restrictions d'ownership sont contractuelles, sans detail d'implementation technique dans ce document.
- En cas de conflit avec RBAC LOCKED V1, RBAC LOCKED V1 prime tant que ce patch n'est pas valide.

## What remains blocked

- OWNER ARBITRATION REQUIRED: niveau exact de droit consultant/worker sur `POST /v1/file-links` (cas limites ownership).
- OWNER ARBITRATION REQUIRED: besoin eventuel d'ouvrir `GET /v1/users` a `agency_user` (actuellement refuse par choix conservateur).

---

## Patch V1.2.2 â€” Surfaces manquantes (Lots 4, 5, 6, 7, 8) â€” decisions OWNER 2026-02-20

Decisions OWNER appliquees:
- Q4: client_user elargi sur validation devis, validation timesheets (double validation), upload docs vigilance.
  Conditionne au flag `tenant_settings.modules.client_portal.level = full`.
- Q5: PATCH /v1/rfps/{id}/visibility ajoute.
- Q6: contact-logs ajoutes pour anti-desintermediation.
- Q9: worker_skills livre V1.
- Q10: SIPSI structure ajoute.
- Q3: push-subscription worker ajoute (Web Push natif).

### ATS â€” Job Offers & Applications (M5)

| Endpoint | tenant_admin | agency_user | consultant | client_user | worker |
| --- | --- | --- | --- | --- | --- |
| POST /v1/job-offers | âœ… | âœ… | âŒ | âŒ | âŒ |
| PATCH /v1/job-offers/{id}/status | âœ… | âœ… | âŒ | âŒ | âŒ |
| GET /v1/job-offers | âœ… | âœ… | âœ… | âŒ | âŒ |
| POST /v1/applications | âœ… | âœ… | âœ… | âŒ | âŒ |
| PATCH /v1/applications/{id}/status | âœ… | âœ… | âŒ | âŒ | âŒ |
| GET /v1/applications | âœ… | âœ… | âœ… (scoped) | âŒ | âŒ |
| POST /v1/applications/{id}:shortlist | âœ… | âœ… | âŒ | âŒ | âŒ |

### Workers & Dossiers (M6)

| Endpoint | tenant_admin | agency_user | consultant | client_user | worker |
| --- | --- | --- | --- | --- | --- |
| POST /v1/workers | âœ… | âœ… | âŒ | âŒ | âŒ |
| GET /v1/workers/{id} | âœ… | âœ… | âœ… (scoped) | âŒ | ğŸ‘ï¸ (own only) |
| PATCH /v1/workers/{id} | âœ… | âœ… | âŒ | âŒ | âŒ |
| GET /v1/workers/{id}/documents | âœ… | âœ… | âœ… (scoped) | âŒ | ğŸ‘ï¸ (own only) |
| POST /v1/workers/{id}/documents | âœ… | âœ… | âŒ | âŒ | âœ… (own only, upload uniquement) |
| GET /v1/workers/{id}/skills | âœ… | âœ… | âœ… (scoped) | âŒ | ğŸ‘ï¸ (own only) |
| POST /v1/workers/{id}/skills | âœ… | âœ… | âŒ | âŒ | âŒ |

### Finance â€” Devis & Commissions (M10) â€” nouveaux endpoints

| Endpoint | tenant_admin | agency_user | consultant | client_user | worker |
| --- | --- | --- | --- | --- | --- |
| POST /v1/quotes | âœ… | âœ… | âŒ | âŒ | âŒ |
| PATCH /v1/quotes/{id} | âœ… | âœ… | âŒ | âŒ | âŒ |
| POST /v1/quotes/{id}:send | âœ… | âœ… | âŒ | âŒ | âŒ |
| POST /v1/quotes/{id}:accept | âœ… | âœ… | âŒ | âœ… (si flag full, Q4) | âŒ |
| GET /v1/quotes/{id} | âœ… | âœ… | âœ… (scoped) | ğŸ‘ï¸ (own only) | âŒ |
| GET /v1/invoices/{id}/commissions | âœ… | âœ… | âŒ | âŒ | âŒ |
| PATCH /v1/commissions/{id}/status | âœ… | âŒ | âŒ | âŒ | âŒ |
| POST /v1/accounting-exports | âœ… | âœ… | âŒ | âŒ | âŒ |
| GET /v1/accounting-exports/{id} | âœ… | âœ… | âŒ | âŒ | âŒ |

### Portail Client elargi (decision Q4-C)

Regle: droits supplementaires conditionnes au flag `tenant_settings.modules.client_portal.level = full`.
Si flag = `readonly` (defaut) : RBAC V1 strict s'applique (lecture seule).

| Endpoint | client_user (flag=full) | client_user (flag=readonly) | Notes |
| --- | --- | --- | --- |
| POST /v1/quotes/{id}:accept | âœ… | âŒ | Validation devis |
| POST /v1/timesheets/{id}:validate | âœ… | âŒ | Si double validation activee |
| POST /v1/clients/{id}/documents | âœ… | âŒ | Upload docs vigilance |

### Compliance Admin â€” Salary Grids (M8, decision Q2-B)

| Endpoint | tenant_admin | agency_user | consultant | client_user | worker | system |
| --- | --- | --- | --- | --- | --- | --- |
| GET /v1/admin/salary-grids | âœ… | ğŸ‘ï¸ | âŒ | âŒ | âŒ | âœ… |
| POST /v1/admin/salary-grids | âœ… | âŒ | âŒ | âŒ | âŒ | âœ… |
| POST /v1/admin/mandatory-pay-items | âœ… | âŒ | âŒ | âŒ | âŒ | âœ… |
| GET /v1/admin/country-rulesets | âœ… | âœ… | âŒ | âŒ | âŒ | âœ… |

### RFP â€” Visibility flag (decision Q5-B)

| Endpoint | tenant_admin | agency_user | consultant | client_user | worker |
| --- | --- | --- | --- | --- | --- |
| PATCH /v1/rfps/{id}/visibility | âœ… | âœ… | âœ… | âŒ | âŒ |

### Anti-desintermediation â€” Contact Logs (decision Q6-B)

| Endpoint | tenant_admin | agency_user | consultant | client_user | worker |
| --- | --- | --- | --- | --- | --- |
| POST /v1/rfps/{id}/contact-logs | âœ… | âœ… | âœ… | âŒ | âŒ |
| GET /v1/rfps/{id}/contact-logs | âœ… | âœ… | âŒ | âŒ | âŒ |

### SIPSI â€” Formulaire structure (decision Q10 A+B)

| Endpoint | tenant_admin | agency_user | consultant | client_user | worker |
| --- | --- | --- | --- | --- | --- |
| POST /v1/compliance-cases/{id}/sipsi-declaration | âœ… | âœ… | âŒ | âŒ | âŒ |
| POST /v1/sipsi-declarations/{id}:submit | âœ… | âœ… | âŒ | âŒ | âŒ |
| GET /v1/sipsi-declarations/{id} | âœ… | âœ… | ğŸ‘ï¸ (scoped) | âŒ | âŒ |

### Worker App â€” Lecture mobile etendue + Push (decisions Q3-A et API mobile M7bis)

| Endpoint | worker | tenant_admin | agency_user |
| --- | --- | --- | --- |
| GET /v1/worker/missions | âœ… (own) | âŒ | âŒ |
| GET /v1/worker/missions/{id} | âœ… (own) | âŒ | âŒ |
| GET /v1/worker/documents | âœ… (own) | âŒ | âŒ |
| GET /v1/worker/missions/{id}/remuneration | âœ… (own) | âŒ | âŒ |
| GET /v1/worker/push-subscription | âœ… (own) | âŒ | âŒ |
| POST /v1/worker/push-subscription | âœ… (own) | âŒ | âŒ |
| DELETE /v1/worker/push-subscription | âœ… (own) | âŒ | âŒ |

Note: tous les endpoints /v1/worker/* sont strictement tenant-scoped et worker-scoped (own only).
Aucun acces cross-worker ni cross-tenant n'est permis.

### Forbidden actions additionnelles (patch V1.2.2)

- `client_user` avec flag=readonly : aucune ecriture sur quotes/timesheets/documents.
- `worker` : aucun acces aux surfaces M5/M6 hors ses propres ressources.
- `consultant` : aucun acces aux surfaces admin salary-grids ou SIPSI.
- `system` : autorise uniquement sur salary-grids et mandatory-pay-items (import batch Q2-C futur).

## Mini-changelog

- 2026-02-19: V1.2.1 owner decisions appliques sur la matrice RBAC des nouvelles surfaces, sans modification LOCKED.
- 2026-02-20: V1.2.2 â€” matrices M5/M6/M10/Quotes/Commissions/Admin/RFP/SIPSI/Push/Mobile ajoutees. Decisions OWNER Q3 Q4 Q5 Q6 Q9 Q10 appliquees.
