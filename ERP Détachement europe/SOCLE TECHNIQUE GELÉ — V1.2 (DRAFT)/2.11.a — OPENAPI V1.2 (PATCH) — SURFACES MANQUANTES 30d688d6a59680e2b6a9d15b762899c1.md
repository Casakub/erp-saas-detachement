# 2.11.a — OPENAPI V1.2 (PATCH) — SURFACES MANQUANTES

- Statut: DRAFT
- Type: DERIVED / DRAFT — does not override LOCKED V1
- Portee: formaliser les surfaces contractuelles manquantes V1.2.1, sans logique metier.

## Sources de reference (lecture seule)

- OpenAPI LOCKED V1: `ERP Détachement europe/SOCLE TECHNIQUE GELÉ — V1 (LOCKED)/2.11 — OPENAPI V1 (PARCOURS MVP) — 1 → 3 → 2 30a688d6a59680b8a5cfc33e26910adb.md`
- Events LOCKED V1: `ERP Détachement europe/SOCLE TECHNIQUE GELÉ — V1 (LOCKED)/2.10 EVENTS MÉTIER V1 (Event-driven, Outbox, IA-fr 30a688d6a5968047ad41e7305d7d9b39.md`
- RBAC LOCKED V1: `ERP Détachement europe/SOCLE TECHNIQUE GELÉ — V1 (LOCKED)/2.12 — RBAC & PERMISSIONS (MATRIX) — V1 30a688d6a596805ea41ae2abb55cbb97.md`
- DB LOCKED V1: `ERP Détachement europe/SOCLE TECHNIQUE GELÉ — V1 (LOCKED)/2.9 - Schéma DB V1 1 (V1 + Patch) 30a688d6a59680edbcb1f475916f9e0a.md`

## Decisions OWNER appliquees (V1.2.1)

1. Auth via Supabase Auth: aucun endpoint `/v1/auth/login` custom.
2. Files: endpoint generique `/v1/files` + endpoints de linking `file_links`.
3. Check events: endpoint unique `POST /v1/check-events` avec `event_type` enum `check_in|check_out`.

## Auth model (Supabase)

- L'authentification est assuree par Supabase Auth.
- L'API metier consomme un JWT valide.
- Toutes les routes ci-dessous exigent `Authorization: Bearer`.
- Le patch V1.2.1 ne cree pas d'endpoints auth custom.

## Patch summary

| Domaine | Endpoints V1.2.1 |
| --- | --- |
| Identity / tenant | `GET /v1/me`, `GET /v1/users`, `POST /v1/users`, `PATCH /v1/users/{user_id}`, `POST /v1/users/{user_id}:deactivate`, `POST /v1/users/{user_id}:reactivate`, `GET /v1/tenant-settings`, `PATCH /v1/tenant-settings` |
| Files | `POST /v1/files`, `GET /v1/files/{file_id}`, `POST /v1/files/{file_id}:soft-delete`, `POST /v1/file-links`, `DELETE /v1/file-links/{file_link_id}` |
| Worker checks | `POST /v1/check-events` |

## Endpoint definitions (contract surfaces)

### 1) GET `/v1/me`

- Request schema: none
- Response schema: `MeResponse`
- Related Events (2.10): none (read route)

### 2) GET `/v1/users`

- Request schema: none
- Response schema: `UserListResponse`
- Related Events (2.10): none (read route)

### 3) POST `/v1/users`

- Request schema: `UserCreateRequest`
- Response schema: `UserCreateResponse`
- Related Events (2.10): `UserCreated`

### 4) PATCH `/v1/users/{user_id}`

- Request schema: `UserPatchRequest`
- Response schema: `UserResponse`
- Related Events (2.10): `UserRoleChanged` si mutation de role incluse.
- OWNER ARBITRATION REQUIRED: confirmer si `role_type` est autorise via ce endpoint ou reserve a une surface dediee.

### 5) POST `/v1/users/{user_id}:deactivate`

- Request schema: none
- Response schema: `UserResponse`
- Related Events (2.10): CONTRACT GAP: event name not confirmed in 2.10 pour changement statut user.

### 6) POST `/v1/users/{user_id}:reactivate`

- Request schema: none
- Response schema: `UserResponse`
- Related Events (2.10): CONTRACT GAP: event name not confirmed in 2.10 pour changement statut user.

### 7) GET `/v1/tenant-settings`

- Request schema: none
- Response schema: `TenantSettingsResponse`
- Related Events (2.10): none (read route)

### 8) PATCH `/v1/tenant-settings`

- Request schema: `TenantSettingsPatchRequest`
- Response schema: `TenantSettingsResponse`
- Related Events (2.10): `TenantSettingsUpdated`

### 9) POST `/v1/files`

- Request schema: `FileUploadRequest`
- Response schema: `FileUploadResponse`
- Related Events (2.10): `FileUploaded`

### 10) GET `/v1/files/{file_id}`

- Request schema: none
- Response schema: `FileResponse`
- Related Events (2.10): `FileAccessed`

### 11) POST `/v1/files/{file_id}:soft-delete`

- Request schema: none
- Response schema: `FileSoftDeleteResponse`
- Related Events (2.10): `FileSoftDeleted`

### 12) POST `/v1/file-links`

- Request schema: `FileLinkCreateRequest`
- Response schema: `FileLinkResponse`
- Related Events (2.10): CONTRACT GAP: event name not confirmed in 2.10 pour creation de file_link.

### 13) DELETE `/v1/file-links/{file_link_id}`

- Request schema: none
- Response schema: `FileLinkResponse`
- Related Events (2.10): CONTRACT GAP: event name not confirmed in 2.10 pour suppression de file_link.

### 14) POST `/v1/check-events`

- Request schema: `CheckEventCreateRequest`
- Response schema: `CheckEventCreateResponse`
- Related Events (2.10): `WorkerCheckEventRecorded`
- Notes: V1 sans geolocalisation; `event_type` est le switch unique check-in/check-out.

## Schema stubs (minimal placeholders)

### MeResponse

- `user_id`: uuid
- `tenant_id`: uuid
- `role`: string

### UserListResponse

- `items`: array of `UserResponse`
- `next_cursor`: string nullable

### UserCreateRequest

- `email`: string
- `role`: string
- `is_active`: boolean

### UserCreateResponse

- `user_id`: uuid
- `tenant_id`: uuid

### UserPatchRequest

- `email`: string optional
- `role`: string optional
- `is_active`: boolean optional

### UserResponse

- `user_id`: uuid
- `tenant_id`: uuid
- `email`: string
- `role`: string
- `is_active`: boolean

### TenantSettingsResponse

- `tenant_id`: uuid
- `settings`: object

### TenantSettingsPatchRequest

- `settings`: object

### FileUploadRequest

- `filename`: string
- `mime_type`: string
- `size_bytes`: integer
- `sha256`: string optional
- `storage_provider`: string optional

### FileUploadResponse

- `file_id`: uuid
- `status`: string
- `uploaded_at`: string
- `sha256`: string optional

### FileResponse

- `file_id`: uuid
- `url`: string optional
- `metadata`: object

### FileSoftDeleteResponse

- `file_id`: uuid
- `status`: string

### FileLinkCreateRequest

- `file_id`: uuid
- `object_type`: enum `mission|worker|client|compliance_case|a1_case|timesheet|invoice|quote`
- `object_id`: uuid

### FileLinkResponse

- `file_link_id`: uuid
- `file_id`: uuid
- `object_type`: string
- `object_id`: uuid
- `created_at`: string

### CheckEventCreateRequest

- `mission_id`: uuid
- `worker_id`: uuid
- `event_type`: enum `check_in|check_out`
- `occurred_at`: string
- `device_info`: object optional

### CheckEventCreateResponse

- `check_event_id`: uuid
- `recorded_at`: string

## Notes contractuelles

- Login/refresh/reset sont hors de cette API, car geres par Supabase Auth.
- Ne pas ajouter d'endpoints auth custom dans ce patch.
- Ce patch clarifie que les endpoints M3 type `/v1/clients/{client_id}/documents` ne remplacent pas la surface generique `/v1/files`.
- Le stockage concret (Supabase Storage, S3, autre) reste un detail d'implementation hors contrat.
- La liaison probatoire est portee par `file_links` (DB 2.9: `file_links`).

## What remains blocked

- OWNER ARBITRATION REQUIRED: confirmer la granularite finale de `PATCH /v1/users/{user_id}` pour les changements de role.
- CONTRACT GAP: nom d'event pour deactivate/reactivate user non confirme dans 2.10.
- CONTRACT GAP: noms d'events pour create/delete `file-links` non confirmes dans 2.10.

## Mini-changelog

- 2026-02-19: V1.2.1 owner decisions appliques (Supabase auth, files+linking, endpoint check-events unique), sans modification LOCKED.
