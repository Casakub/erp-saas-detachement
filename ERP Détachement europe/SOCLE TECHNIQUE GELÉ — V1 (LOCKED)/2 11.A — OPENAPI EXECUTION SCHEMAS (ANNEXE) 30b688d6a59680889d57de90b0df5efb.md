# 2 11.A â€” OPENAPI EXECUTION SCHEMAS (ANNEXE)

Statut: DRAFT (LOCK REQUIRED)
Applicabilite: immediate comme annexe d'execution contract-first
Portee: completer les zones "Non specifie dans cette section" de 2.11 sans modifier 2.11

## 1) Regles de cette annexe

- Cette annexe ne cree aucun endpoint nouveau.
- Cette annexe ne modifie pas les contrats LOCKED 2.9/2.10/2.11/2.12.
- Les schemas ci-dessous sont minimaux: uniquement champs explicites dans 2.11 ou implicites par 2.9.
- En cas de doute, se conformer au schema DB 2.9 et au catalogue events 2.10.
- Pour les endpoints de gate, une reponse `422 business_rule_failed` doit inclure `blocking_reasons`.

## 2) Inventaire des endpoints 2.11 avec "Non specifie dans cette section"

1. GET `/v1/missions/{mission_id}`
2. GET `/v1/missions/{mission_id}/compliance-case`
3. POST `/v1/missions/{mission_id}/compliance-case/requirements/initialize`
4. GET `/v1/compliance-cases/{compliance_case_id}/requirements`
5. PATCH `/v1/requirements/{requirement_id}/status`
6. PATCH `/v1/a1-requests/{a1_request_id}/status`
7. POST `/v1/compliance-cases/{compliance_case_id}/remuneration/snapshots:calculate`
8. GET `/v1/missions/{mission_id}/enforcement`
9. POST `/v1/missions/{mission_id}/enforcement:evaluate`
10. POST `/v1/timesheets/{timesheet_id}:submit`
11. POST `/v1/timesheets/{timesheet_id}:validate`
12. POST `/v1/invoices/{invoice_id}:issue`
13. POST `/v1/invoices/{invoice_id}:block`
14. POST `/v1/invoices/{invoice_id}:void`
15. POST `/v1/payments`
16. PATCH `/v1/timesheets/{timesheet_id}/billing-status`
17. PATCH `/v1/leads/{lead_id}/status`
18. GET `/v1/leads`
19. POST `/v1/clients`
20. POST `/v1/clients/{client_id}/sites`
21. POST `/v1/clients/{client_id}/documents`
22. POST `/v1/rfps/{rfp_id}:publish`
23. POST `/v1/rfps/{rfp_id}/invites`
24. POST `/v1/rfps/{rfp_id}/responses`
25. POST `/v1/rfps/{rfp_id}:create-mission-draft`
26. POST `/v1/tasks`
27. PATCH `/v1/tasks/{task_id}/status`
28. GET `/v1/tasks`
29. PATCH `/v1/agency-profile`

## 3) Schemas d'execution minimaux par endpoint

### 3.1 Parcours Missions / Compliance / Enforcement

#### GET `/v1/missions/{mission_id}`

Request minimal:
- Path: `mission_id` (uuid)

Response 200 minimal:
- `mission_id`
- `mission_number`
- `status`
- `client_id`
- `site_id`
- `worker_id`
- `corridor_origin_country`
- `corridor_host_country`
- `start_date`
- `end_date`
- `enforcement.can_activate_mission`
- `enforcement.can_validate_timesheets`
- `enforcement.can_issue_invoice`
- `enforcement.blocking_reasons`

Erreurs possibles:
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (mission)

Events 2.10:
- Aucun event metier publie (lecture)

#### GET `/v1/missions/{mission_id}/compliance-case`

Request minimal:
- Path: `mission_id` (uuid)

Response 200 minimal:
- `compliance_case_id`
- `case_number`
- `mission_id`
- `status`
- `corridor_origin_country`
- `corridor_host_country`
- `cumulative_duration_days`
- `last_reviewed_at`

Erreurs possibles:
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (mission ou compliance_case)

Events 2.10:
- Aucun event metier publie (lecture)

#### POST `/v1/missions/{mission_id}/compliance-case/requirements/initialize`

Request minimal:
- Path: `mission_id` (uuid)
- Body: aucun champ requis

Response 200 minimal:
- `created` (int)
- `updated` (int)

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (mission ou compliance_case)
- `409 conflict` (etat incompatible pour initialisation)

Events 2.10:
- `ComplianceRequirementCreated` (M8)

#### GET `/v1/compliance-cases/{compliance_case_id}/requirements`

Request minimal:
- Path: `compliance_case_id` (uuid)

Response 200 minimal:
- Tableau de requirements:
- `requirement_id`
- `requirement_code`
- `label`
- `status`
- `due_date`
- `provided_file_id`

Erreurs possibles:
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (compliance_case)

Events 2.10:
- Aucun event metier publie (lecture)

#### PATCH `/v1/requirements/{requirement_id}/status`

Request minimal:
- Path: `requirement_id` (uuid)
- Body:
- `status` (`provided|approved|rejected`)
- `notes` (string|null)

Response 200 minimal:
- `requirement_id`
- `status`
- `notes`

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (requirement)
- `409 conflict` (transition de statut invalide)
- `422 business_rule_failed` (regle metier de case)

Events 2.10:
- `ComplianceRequirementStatusChanged` (M8)
- `MissionEnforcementEvaluated` (M8, si flags modifies)

#### PATCH `/v1/a1-requests/{a1_request_id}/status`

Request minimal:
- Path: `a1_request_id` (uuid)
- Body:
- `status` (`not_requested|pending|issued|expired|rejected`)
- `requested_at` (ISO|null)
- `issued_at` (ISO|null)
- `expires_at` (ISO|null)
- `rejection_reason` (string|null)
- `file_id` (uuid|null)

Response 200 minimal:
- `a1_request_id`
- `status`
- `requested_at`
- `issued_at`
- `expires_at`
- `rejection_reason`
- `file_id`

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (a1_request)
- `409 conflict` (transition A1 invalide)
- `422 business_rule_failed` (regle metier de case)

Events 2.10:
- `A1StatusUpdated` (M8)
- `MissionEnforcementEvaluated` (M8, si flags modifies)

#### POST `/v1/compliance-cases/{compliance_case_id}/remuneration/snapshots:calculate`

Request minimal:
- Path: `compliance_case_id` (uuid)
- Body: aucun champ requis

Response 201 minimal:
- `snapshot_id`
- `is_compliant`
- `legal_minimum_amount`
- `legal_minimum_unit`
- `eligible_remuneration_amount`
- `excluded_expenses_amount`
- `engine_version`
- `calculated_at`

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (compliance_case)
- `409 conflict` (snapshot non calculable en l'etat)
- `422 business_rule_failed` (inputs remuneration insuffisants/incoherents)

Events 2.10:
- `RemunerationSnapshotCreated` (M8)
- `MissionEnforcementEvaluated` (M8, si flags modifies)

#### GET `/v1/missions/{mission_id}/enforcement`

Request minimal:
- Path: `mission_id` (uuid)

Response 200 minimal:
- `mission_id`
- `can_activate_mission`
- `can_validate_timesheets`
- `can_issue_invoice`
- `blocking_reasons`
- `last_evaluated_at`

Erreurs possibles:
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (mission)

Events 2.10:
- Aucun event metier publie (lecture)

#### POST `/v1/missions/{mission_id}/enforcement:evaluate`

Request minimal:
- Path: `mission_id` (uuid)
- Body: aucun champ requis

Response 200 minimal:
- `changed` (bool)
- `blocking_reasons` (array)

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (mission)

Events 2.10:
- `MissionEnforcementEvaluated` (M8, si flags modifies)

### 3.2 Parcours Timesheets / Billing / Payments

#### POST `/v1/timesheets/{timesheet_id}:submit`

Request minimal:
- Path: `timesheet_id` (uuid)
- Body: aucun champ requis

Response 200 minimal:
- `timesheet_id`
- `status` (`submitted`)

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (timesheet)
- `409 conflict` (statut timesheet incompatible)

Events 2.10:
- `TimesheetSubmitted` (M7.T)
- `MissionEnforcementEvaluated` (M8, indirect si necessaire)

#### POST `/v1/timesheets/{timesheet_id}:validate`

Request minimal:
- Path: `timesheet_id` (uuid)
- Body: aucun champ requis

Response 200 minimal:
- `timesheet_id`
- `status` (`validated`)

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (timesheet)
- `409 conflict` (statut timesheet incompatible)
- `422 business_rule_failed` avec `blocking_reasons` (enforcement interdit validation)

Events 2.10:
- `TimesheetValidated` (M7.T)

#### POST `/v1/invoices/{invoice_id}:issue`

Request minimal:
- Path: `invoice_id` (uuid)
- Body: aucun champ requis

Response 200 minimal:
- `invoice_id`
- `from` (`draft`)
- `to` (`issued`)
- `issued_at`

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (invoice)
- `409 conflict` (transition draft->issued impossible)
- `422 business_rule_failed` avec `blocking_reasons` (enforcement interdit emission)

Events 2.10:
- `InvoiceIssued` (M10)

#### POST `/v1/invoices/{invoice_id}:block`

Request minimal:
- Path: `invoice_id` (uuid)
- Body:
- `blocked_reason` (array)
- `notes` (string|null)

Response 200 minimal:
- `invoice_id`
- `status` (`blocked`)
- `blocked_reason`
- `blocked_at`

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (invoice)
- `409 conflict` (etat incompatible)

Events 2.10:
- `InvoiceBlocked` (M10)

#### POST `/v1/invoices/{invoice_id}:void`

Request minimal:
- Path: `invoice_id` (uuid)
- Body: aucun champ requis

Response 200 minimal:
- `invoice_id`
- `status` (`voided`)

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (invoice)
- `409 conflict` (etat incompatible)

Events 2.10:
- `InvoiceVoided` (M10, optionnel V1 selon 2.11)

#### POST `/v1/payments`

Request minimal:
- Body:
- `invoice_id` (uuid)
- `amount` (number)
- `paid_at` (ISO)
- `method` (`bank|card|other`)
- `reference` (string|null)

Response 201 minimal:
- `payment_id`
- `invoice_id`
- `amount`
- `paid_at`
- `method`
- `reference`

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (invoice)
- `409 conflict` (paiement en doublon / etat facture incompatible)
- `422 business_rule_failed` (regle metier finance)

Events 2.10:
- `PaymentRecorded` (M10)
- `ConsultantCommissionCalculated` (M10, si regle active)

#### PATCH `/v1/timesheets/{timesheet_id}/billing-status`

Request minimal:
- Path: `timesheet_id` (uuid)
- Body:
- `billing_status` (`not_billed|billed|disputed`)
- `invoice_id` (uuid|null)

Response 200 minimal:
- `timesheet_id`
- `billing_status`
- `invoice_id`

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (timesheet)
- `409 conflict` (transition billing_status invalide)
- `422 business_rule_failed` (regle metier finance)

Events 2.10:
- `TimesheetBillingStatusChanged` (M10)

### 3.3 Parcours CRM / Clients / RFP

#### PATCH `/v1/leads/{lead_id}/status`

Request minimal:
- Path: `lead_id` (uuid)
- Body:
- `status` (`new|contacted|qualified|won|lost`)

Response 200 minimal:
- `lead_id`
- `status`

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (lead)
- `409 conflict` (transition de statut invalide)

Events 2.10:
- `LeadStatusChanged` (M2)

#### GET `/v1/leads`

Request minimal:
- Query optionnelle:
- `status`
- `owner_user_id`
- `sector`
- `corridor_target`
- pagination standard (`limit`, `cursor`)

Response 200 minimal:
- `items[]` avec au moins:
- `lead_id`
- `status`
- `company_name`
- `owner_user_id`
- `country`
- `sector`
- `corridor_target`
- `next_cursor` (nullable)

Erreurs possibles:
- `400 validation_error` (filtre/pagination)
- `401 unauthenticated`
- `403 forbidden`

Events 2.10:
- Aucun event metier publie (lecture)

#### POST `/v1/clients`

Request minimal:
- Body:
- `name`
- `legal_form`
- `siret`
- `vat_number`
- `billing_email`
- `account_owner_user_id`
- `status`
- `default_language`

Response 201 minimal:
- `client_id`
- `name`
- `status`
- `default_language`

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `409 conflict` (unicite legale selon regles tenant)
- `422 business_rule_failed` (regle metier client)

Events 2.10:
- `ClientCreated` (M3)

#### POST `/v1/clients/{client_id}/sites`

Request minimal:
- Path: `client_id` (uuid)
- Body:
- `name`
- `address_line1`
- `address_line2`
- `city`
- `postal_code`
- `country`
- `is_primary`

Response 201 minimal:
- `site_id`
- `client_id`
- `name`
- `city`
- `country`
- `is_primary`

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (client)
- `409 conflict` (contrainte is_primary/adresse)

Events 2.10:
- `ClientSiteCreated` (M3)

#### POST `/v1/clients/{client_id}/documents`

Request minimal:
- Path: `client_id` (uuid)
- Body:
- `doc_type` (`kbis|insurance|urssaf|other`)
- `doc_status`
- `valid_from`
- `valid_to`
- `file_id`
- `notes`

Response 201 minimal:
- `client_document_id`
- `client_id`
- `doc_type`
- `doc_status`
- `file_id`
- `valid_to`

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (client ou file)
- `409 conflict` (doublon documentaire)
- `422 business_rule_failed` (regle vigilance)

Events 2.10:
- `ClientDocumentStatusChanged` (M3)

#### POST `/v1/rfps/{rfp_id}:publish`

Request minimal:
- Path: `rfp_id` (uuid)
- Body: aucun champ requis

Response 200 minimal:
- `rfp_id`
- `status` (`sent|receiving`)

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (rfp)
- `409 conflict` (transition de statut invalide)

Events 2.10:
- `RfpPublished` (M4)

#### POST `/v1/rfps/{rfp_id}/invites`

Request minimal:
- Path: `rfp_id` (uuid)
- Body:
- `agency_tenant_ids` (array uuid)

Response 200 minimal:
- `rfp_id`
- `invited_count`
- `invite_ids`

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (rfp)
- `409 conflict` (invite deja existante)

Events 2.10:
- `RfpInviteCreated` (M4)

#### POST `/v1/rfps/{rfp_id}/responses`

Request minimal:
- Path: `rfp_id` (uuid)
- Body:
- `agency_tenant_id`
- `price_model` (`hourly|daily|fixed`)
- `proposed_rate`
- `availability_notes`

Response 201 minimal:
- `response_id`
- `rfp_id`
- `agency_tenant_id`
- `status` (`submitted`)

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (rfp)
- `409 conflict` (reponse deja soumise)
- `422 business_rule_failed` (tenant non invite)

Events 2.10:
- `RfpResponseSubmitted` (M4)

#### POST `/v1/rfps/{rfp_id}:create-mission-draft`

Request minimal:
- Path: `rfp_id` (uuid)
- Body:
- `client_id`
- `site_id`
- `sector`
- `job_title`
- `corridor_origin_country`
- `corridor_host_country`
- `start_date`
- `end_date`
- `weekly_hours`

Response 201 minimal:
- `mission_id`
- `mission_number`
- `status` (`planned`)
- `rfp_id`

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (rfp/client/site)
- `409 conflict` (allocation non confirmee)
- `422 business_rule_failed` (regle metier creation mission)

Events 2.10:
- `MissionCreated` (M7)
- `ComplianceCaseCreated` (M8, indirect)

### 3.4 Endpoints transverses Tasks / Agency Profile

#### POST `/v1/tasks`

Request minimal:
- Body:
- `title`
- `description`
- `priority` (`low|medium|high|urgent`)
- `due_at`
- `assigned_to_user_id`
- `entity_type`
- `entity_id`
- `tags`

Response 201 minimal:
- `task_id`
- `title`
- `status` (`todo`)
- `priority`
- `due_at`
- `assigned_to_user_id`
- `entity_type`
- `entity_id`

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (entity liee)
- `422 business_rule_failed` (regle de liaison entity)

Events 2.10:
- `TaskCreated` (M12)

#### PATCH `/v1/tasks/{task_id}/status`

Request minimal:
- Path: `task_id` (uuid)
- Body:
- `status` (`todo|in_progress|done|cancelled`)

Response 200 minimal:
- `task_id`
- `status`

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (task)
- `409 conflict` (transition de statut invalide)

Events 2.10:
- `TaskStatusChanged` (M12)

#### GET `/v1/tasks`

Request minimal:
- Query optionnelle:
- `status`
- `assigned_to_user_id`
- `due_before`
- `entity_type`
- `entity_id`
- pagination standard (`limit`, `cursor`)

Response 200 minimal:
- `items[]` avec au moins:
- `task_id`
- `title`
- `status`
- `priority`
- `due_at`
- `assigned_to_user_id`
- `entity_type`
- `entity_id`
- `next_cursor` (nullable)

Erreurs possibles:
- `400 validation_error` (filtre/pagination)
- `401 unauthenticated`
- `403 forbidden`

Events 2.10:
- Aucun event metier publie (lecture)

#### PATCH `/v1/agency-profile`

Request minimal:
- Body:
- `legal_name`
- `trade_name`
- `country_code`
- `vat_number`
- `tax_id`
- `registration_id`
- `contact_email`
- `phone`
- `address`

Response 200 minimal:
- `agency_profile_id`
- `tenant_id`
- `legal_name`
- `trade_name`
- `country_code`
- `vat_number`
- `tax_id`
- `registration_id`
- `contact_email`
- `phone`
- `address`
- `status`

Erreurs possibles:
- `400 validation_error`
- `401 unauthenticated`
- `403 forbidden`
- `404 not_found` (agency_profile)
- `409 conflict` (contrainte unique tenant)

Events 2.10:
- `AgencyProfileUpdated` (M12)

## 4) Notes d'alignement contractuel

- Les statuts de transition et validations doivent suivre les enums 2.9.
- Les payloads de mutation doivent rester compatibles avec la publication outbox 2.10.
- Aucun endpoint mutant de cette annexe ne peut publier un event hors catalogue 2.10.

## 5) Changelog doc

- 2026-02-18: Creation de l'annexe 2 11.A pour couvrir les zones "Non specifie dans cette section" de 2.11 sans modification du fichier LOCKED.
